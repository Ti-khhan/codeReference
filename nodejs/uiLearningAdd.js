//npm install python-shell -save
var PythonShell = require('python-shell')
var sync = require('./sync.js')
var appRoot = require('app-root-path').path;
var dbConfig = require(appRoot + '/config/dbConfig');
var oracle = require('./oracle.js');
const oracledb = require('oracledb');
var async = require('async');
var execSync = require('child_process').execSync;
var pythonConfig = require(appRoot + '/config/pythonConfig');

PythonShell.run = sync(PythonShell.run);
oracle.insertOcrSymsSingle = sync(oracle.insertOcrSymsSingle);
oracle.insertContractMapping = sync(oracle.insertContractMapping);
oracle.selectSid = sync(oracle.selectSid);
oracle.insertColumnMapping = sync(oracle.insertColumnMapping);

sync.fiber(function () {
    sync.await(uiTraingAdd(sync.defer()));
});


function uiTraingAdd(done) {
    sync.fiber(function () {
        try {
            var beforeData = makeBeforeData();
            var afterData = makeAfterData();

            for (var i in afterData.data) {
                for (var j in beforeData.data) {
                    if (afterData.data[i].location == beforeData.data[j].location) {
                        //사용자가 글자를 직접 수정한 경우 TBL_CONTRACT_MAPPING에 insert
                        // if (afterData.data[i].text != beforeData.data[j].text) {
                        //     var item = [beforeData.data[j].text, '', afterData.data[i].text, ''];
                        //     sync.await(oracle.insertContractMapping(item, sync.defer()));
                        // }
                        //사용자가 지정한 컬럼라벨의 텍스트가 유효한 컬럼의 경우 OcrSymspell에 before text(중요!!) insert
                        if (afterData.data[i].colLbl >= 0 && afterData.data[i].colLbl <= 34) {
                            //UY의 경우 텍스트는 무의미 위치 정보로 체크필요
                            if (afterData.data[i].colLbl != 3) {
                                sync.await(oracle.insertOcrSymsSingle(beforeData.data[j], sync.defer()));
                            }
                        }
                        afterData.data[i].sid = sync.await(oracle.selectSid(beforeData.data[j], sync.defer()));
                    } 
                }
                
            }


            sync.await(oracle.insertColumnMapping(afterData, sync.defer()));

            pythonConfig.columnMappingOptions.args = [];
            pythonConfig.columnMappingOptions.args = ["training"];
    
            sync.await(PythonShell.run('columnClassicify.py', pythonConfig.columnMappingOptions, sync.defer()));
    
            callback(data);


            console.log("done");
            return done(null, "");
        } catch (e) {
            console.log(e);
            return done(null, e);
        }
    });
}

function makeBeforeData () {
    var temp = '{"code":200,"data":[{"location":"1392,16,243,16","text":"172.16. tv.71/2018.02.22 17,32/oi","originText":"172.16. tv.71/2018.02.22 17,32/oi","sid":"1392,16,1635,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"1468,250,142,17","text":"empower results","originText":"empower results","sid":"1468,250,1610,30163,14681,0,0,0","colLbl":20,"colAccu":0.99},{"location":"1008,328,353,23","text":"asiapacific.prorata@aonbenfield.com","originText":"asiapacific.prorata@aonbenfield.com","sid":"1008,328,1361,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"1073,409,122,15","text":"20-feb-2018","originText":"20-feb-2018","sid":"1073,409,1195,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"1075,434,95,17","text":"10600563","originText":"10600563","sid":"1075,434,1170,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1073,458,258,20","text":"goi 1-00844a-1002aa 2az","originText":"goi 1-00844a-1002aa 2az","sid":"1073,458,1331,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"93,304,445,23","text":"reinsurance department (ab china - china tty)","originText":"reinsurance department (ab china - china tty)","sid":"93,304,538,34107,14809,0,15053,97339","colLbl":0,"colAccu":0.99},{"location":"15,305,30,17","text":"to:","originText":"to:","sid":"15,305,45,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"94,331,283,20","text":"korean reinsurance company","originText":"korean reinsurance company","sid":"94,331,377,18699,34107,14623,0,0","colLbl":0,"colAccu":0.99},{"location":"93,356,166,20","text":"80 sousong-dong","originText":"80 sousong-dong","sid":"93,356,259,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"92,383,116,19","text":"chongno-gu","originText":"chongno-gu","sid":"92,383,208,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"92,408,137,16","text":"seoul 110-140","originText":"seoul 110-140","sid":"92,408,229,26213,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"94,434,220,20","text":"korea, republic of","originText":"korea, republic of","sid":"94,434,314,0,15890,14456,0,0","colLbl":5,"colAccu":0.99},{"location":"426,1016,69,16","text":"co. ltd","originText":"co. ltd","sid":"426,1016,495,0,15632,0,0,0","colLbl":5,"colAccu":0.99},{"location":"710,224,232,19","text":"account invoice","originText":"account invoice","sid":"710,224,942,14793,21391,0,0,0","colLbl":21,"colAccu":0.99},{"location":"801,331,83,16","text":"contact:","originText":"contact:","sid":"801,331,884,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"802,356,68,16","text":"phone:","originText":"phone:","sid":"802,356,870,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"801,409,129,15","text":"invoice date:","originText":"invoice date:","sid":"801,409,930,21391,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"801,434,203,17","text":"invoice/retacc no:","originText":"invoice/retacc no:","sid":"801,434,1004,97342,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"801,461,114,16","text":"our ref no:","originText":"our ref no:","sid":"801,461,915,14498,17691,0,0,0","colLbl":21,"colAccu":0.99},{"location":"801,513,68,15","text":"tax id:","originText":"tax id:","sid":"801,513,869,14958,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"15,577,144,15","text":"contract with:","originText":"contract with:","sid":"15,577,159,15610,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"14,603,156,16","text":"contract name:","originText":"contract name:","sid":"14,603,170,15610,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"15,629,173,19","text":"coverage period:","originText":"coverage period:","sid":"15,629,188,16250,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"14,655,186,16","text":"your contract ref:","originText":"your contract ref:","sid":"14,655,200,14478,15610,0,0,0","colLbl":21,"colAccu":0.99},{"location":"16,681,119,15","text":"descri tion:","originText":"descri tion:","sid":"16,681,135,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"240,576,305,20","text":"guoyuan agricultural ins. co. ltd","originText":"guoyuan agricultural ins. co. ltd","sid":"240,576,545,97346,17403,0,0,15632","colLbl":20,"colAccu":0.99},{"location":"240,600,599,23","text":"non marine comb qs & surp tty - section - quota share-vat","originText":"non marine comb qs & surp tty - section - quota share-vat","sid":"240,600,839,14812,16518,28709,97294,0","colLbl":20,"colAccu":0.99},{"location":"241,628,256,18","text":"01-feb-2010 - 31-jan-2011","originText":"01-feb-2010 - 31-jan-2011","sid":"241,628,497,0,97339,0,0,0","colLbl":5,"colAccu":0.99},{"location":"241,680,684,16","text":"01-oct-2017-31-dec-2017 re ort former polic number:008442010aa","originText":"01-oct-2017-31-dec-2017 re ort former polic number:008442010aa","sid":"241,680,925,0,14569,40471,16129,0","colLbl":20,"colAccu":0.99},{"location":"41,836,246,17","text":"transaction information:","originText":"transaction information:","sid":"41,836,287,17705,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"63,862,220,18","text":"ceded written premium","originText":"ceded written premium","sid":"63,862,283,51197,15234,16438,0,0","colLbl":0,"colAccu":0.99},{"location":"63,889,183,19","text":"ceding commission","originText":"ceding commission","sid":"63,889,246,64068,15444,0,0,0","colLbl":20,"colAccu":0.99},{"location":"62,914,121,17","text":"chinese vat","originText":"chinese vat","sid":"62,914,183,15861,17867,0,0,0","colLbl":21,"colAccu":0.99},{"location":"63,939,225,21","text":"chinese vat surcharge","originText":"chinese vat surcharge","sid":"63,939,288,15861,17867,29649,0,0","colLbl":0,"colAccu":0.99},{"location":"63,966,208,18","text":"chinese vat withheld","originText":"chinese vat withheld","sid":"63,966,271,15861,17867,27609,0,0","colLbl":0,"colAccu":0.99},{"location":"63,1016,355,23","text":"net due (to) guoyuan agricultural ins.","originText":"net due (to) guoyuan agricultural ins.","sid":"63,1016,418,15097,15182,0,97346,17403","colLbl":7,"colAccu":0.99},{"location":"42,1071,143,16","text":"balances due:","originText":"balances due:","sid":"42,1071,185,24792,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"63,1096,99,16","text":"gross due","originText":"gross due","sid":"63,1096,162,18455,15182,0,0,0","colLbl":20,"colAccu":0.99},{"location":"64,1122,212,19","text":"brokerage/fee amount","originText":"brokerage/fee amount","sid":"64,1122,276,0,15288,0,0,0","colLbl":5,"colAccu":0.99},{"location":"63,1146,452,20","text":"net due from korean reinsurance company","originText":"net due from korean reinsurance company","sid":"63,1146,515,15097,15182,14475,18699,34107","colLbl":7,"colAccu":0.99},{"location":"42,1201,264,20","text":"supplemental information:","originText":"supplemental information:","sid":"42,1201,306,22430,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"63,1227,231,20","text":"ceded outstanding loss","originText":"ceded outstanding loss","sid":"63,1227,294,51197,17747,15389,0,0","colLbl":0,"colAccu":0.99},{"location":"968,733,148,19","text":"currency: cny","originText":"currency: cny","sid":"968,733,1116,97344,97345,0,0,0","colLbl":35,"colAccu":0.99},{"location":"800,889,126,20","text":"@ 24.500000%","originText":"@ 24.500000%","sid":"800,889,926,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"726,916,188,19","text":"(212.33) @ 6.000000%","originText":"(212.33) @ 6.000000%","sid":"726,916,914,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"726,942,187,18","text":"(212.33) @ 0.720000%","originText":"(212.33) @ 0.720000%","sid":"726,942,913,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"725,968,188,22","text":"(?12.33) @ 6.000000%","originText":"(?12.33) @ 6.000000%","sid":"725,968,913,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"726,1120,188,24","text":"(212.33) @ 2.500000%","originText":"(212.33) @ 2.500000%","sid":"726,1120,914,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"1211,784,130,16","text":"100.000000%","originText":"100.000000%","sid":"1211,784,1341,97343,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"1263,862,80,21","text":"212.33","originText":"(212.33)","sid":"1263,862,1343,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1274,888,68,23","text":"52.02","originText":"(52.02)","sid":"1274,888,1342,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1301,1226,41,19","text":"0.00","originText":"0.00","sid":"1301,1226,1342,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"43,1304,1209,22","text":"please settle debit balances as soon as possible. we shall settle the credit balances upon receipt from the debtor party.","originText":"please settle debit balances as soon as possible. we shall settle the credit balances upon receipt from the debtor party.","sid":"43,1304,1252,14592,22392,24078,24792,14477","colLbl":20,"colAccu":0.99},{"location":"326,2224,1009,21","text":"on eenfield china limited, tvver 1 times square, matheson street, causeway hong rong t (852) 2861 6555 f, (852)o65 5296","originText":"on eenfield china limited, tvver 1 times square, matheson street, causeway hong rong t (852) 2861 6555 f, (852)o65 5296","sid":"326,2224,1335,14463,0,15053,0,0","colLbl":0,"colAccu":0.99},{"location":"1509,758,108,17","text":"7.500000%","originText":"7.500000%","sid":"1509,758,1617,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"1385,784,233,16","text":"of a 100.000000% order","originText":"of a 100.000000% order","sid":"1385,784,1618,14456,14459,97343,14618,0","colLbl":20,"colAccu":0.99},{"location":"1551,862,66,22","text":"15.92","originText":"(15.92)","sid":"1551,862,1617,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1562,889,56,20","text":"3.90","originText":"(3.90)","sid":"1562,889,1618,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1562,913,55,23","text":"0.96","originText":"(0.96)","sid":"1562,913,1617,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1577,940,37,17","text":"0.11","originText":"0.11","sid":"1577,940,1614,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1576,966,41,17","text":"0.96","originText":"0.96","sid":"1576,966,1617,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1559,1016,48,18","text":"11.91","originText":"11.91","sid":"1559,1016,1607,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1565,1096,50,16","text":"11.91","originText":"11.91","sid":"1565,1096,1615,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1563,1120,54,21","text":"0.40","originText":"(0.40)","sid":"1563,1120,1617,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1566,1149,49,15","text":"11.51","originText":"11.51","sid":"1566,1149,1615,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1577,1226,41,18","text":"0.00","originText":"0.00","sid":"1577,1226,1618,1,1,1,1,1","colLbl":20,"colAccu":0.99},{"location":"1421,2269,67,18","text":"page pf","originText":"page pf","sid":"1421,2269,1488,14492,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"0,2320,302,18","text":"copyright@korean *insurance comoan","originText":"copyright@korean *insurance comoan","sid":"0,2320,302,0,0,0,0,0","colLbl":30,"colAccu":0.99},{"location":"322,2321,50,17","text":"all agh","originText":"all agh","sid":"322,2321,372,14479,0,0,0,0","colLbl":20,"colAccu":0.99},{"location":"584,2250,480,17","text":"this is an electronically generated document nosignaturejs required","originText":"this is an electronically generated document nosignaturejs required","sid":"584,2250,1064,14466,14462,14483,24163,16456","colLbl":20,"colAccu":0.99},{"location":"373,2323,86,13","text":"ts reserved","originText":"ts reserved","sid":"373,2323,459,0,14698,0,0,0","colLbl":5,"colAccu":0.99,"entryLbl":30}]}'
    var resPyArr = JSON.parse(temp.replace(/'/g, '"'));
    return resPyArr;
}

function makeAfterData () {
    var temp = '{"data":[{"location":"1392,16,243,16","text":"172.16. tv.71/2018.02.22 17,32/oi","colLbl":"38"},{"location":"1468,250,142,17","text":"empower results","colLbl":"38"},{"location":"1008,328,353,23","text":"asiapacific.prorata@aonbenfield.com","colLbl":"38"},{"location":"1073,409,122,15","text":"20-feb-2018","colLbl":"38"},{"location":"1075,434,95,17","text":"10600563","colLbl":"35"},{"location":"1073,458,258,20","text":"goi 1-00844a-1002aa 2az","colLbl":"38"},{"location":"93,304,445,23","text":"reinsurance department (ab china - china tty)","colLbl":"38"},{"location":"15,305,30,17","text":"to:","colLbl":"38"},{"location":"94,331,283,20","text":"korean reinsurance company","colLbl":"38"},{"location":"93,356,166,20","text":"80 sousong-dong","colLbl":"38"},{"location":"92,383,116,19","text":"chongno-gu","colLbl":"38"},{"location":"92,408,137,16","text":"seoul 110-140","colLbl":"38"},{"location":"94,434,220,20","text":"korea, republic of","colLbl":"38"},{"location":"426,1016,69,16","text":"co. ltd","colLbl":"38"},{"location":"710,224,232,19","text":"account invoice","colLbl":"38"},{"location":"801,331,83,16","text":"contact:","colLbl":"38"},{"location":"802,356,68,16","text":"phone:","colLbl":"38"},{"location":"801,409,129,15","text":"invoice date:","colLbl":"38"},{"location":"801,434,203,17","text":"invoice/retacc no:","colLbl":"38"},{"location":"801,461,114,16","text":"our ref no:","colLbl":"38"},{"location":"801,513,68,15","text":"tax id:","colLbl":"38"},{"location":"15,577,144,15","text":"contract with:","colLbl":"38"},{"location":"14,603,156,16","text":"contract name:","colLbl":"38"},{"location":"15,629,173,19","text":"coverage period:","colLbl":"38"},{"location":"14,655,186,16","text":"your contract ref:","colLbl":"38"},{"location":"16,681,119,15","text":"descri tion:","colLbl":"38"},{"location":"240,576,305,20","text":"guoyuan agricultural ins. co. ltd","colLbl":"0"},{"location":"240,600,599,23","text":"non marine comb qs & surp tty - section - quota share-vat","colLbl":"1"},{"location":"241,628,256,18","text":"01-feb-2010 - 31-jan-2011","colLbl":"2"},{"location":"241,680,684,16","text":"01-oct-2017-31-dec-2017 re ort former polic number:008442010aa","colLbl":"38"},{"location":"41,836,246,17","text":"transaction information:","colLbl":"38"},{"location":"63,862,220,18","text":"ceded written premium","colLbl":"9"},{"location":"63,889,183,19","text":"ceding commission","colLbl":"14"},{"location":"62,914,121,17","text":"chinese vat","colLbl":"38"},{"location":"63,939,225,21","text":"chinese vat surcharge","colLbl":"17"},{"location":"63,966,208,18","text":"chinese vat withheld","colLbl":"38"},{"location":"63,1016,355,23","text":"net due (to) guoyuan agricultural ins.","colLbl":"38"},{"location":"42,1071,143,16","text":"balances due:","colLbl":"38"},{"location":"63,1096,99,16","text":"gross due","colLbl":"38"},{"location":"64,1122,212,19","text":"brokerage/fee amount","colLbl":"16"},{"location":"63,1146,452,20","text":"net due from korean reinsurance company","colLbl":"38"},{"location":"42,1201,264,20","text":"supplemental information:","colLbl":"38"},{"location":"63,1227,231,20","text":"ceded outstanding loss","colLbl":"38"},{"location":"968,733,148,19","text":"currency: cny","colLbl":"3"},{"location":"800,889,126,20","text":"@ 24.500000%","colLbl":"38"},{"location":"726,916,188,19","text":"(212.33) @ 6.000000%","colLbl":"38"},{"location":"726,942,187,18","text":"(212.33) @ 0.720000%","colLbl":"38"},{"location":"725,968,188,22","text":"(?12.33) @ 6.000000%","colLbl":"38"},{"location":"726,1120,188,24","text":"(212.33) @ 2.500000%","colLbl":"38"},{"location":"1211,784,130,16","text":"100.000000%","colLbl":"38"},{"location":"1263,862,80,21","text":"212.33","colLbl":"38"},{"location":"1274,888,68,23","text":"52.02","colLbl":"38"},{"location":"1301,1226,41,19","text":"0.00","colLbl":"38"},{"location":"43,1304,1209,22","text":"please settle debit balances as soon as possible. we shall settle the credit balances upon receipt from the debtor party.","colLbl":"38"},{"location":"326,2224,1009,21","text":"on eenfield china limited, tvver 1 times square, matheson street, causeway hong rong t (852) 2861 6555 f, (852)o65 5296","colLbl":"38"},{"location":"1509,758,108,17","text":"7.500000%","colLbl":"38"},{"location":"1385,784,233,16","text":"of a 100.000000% order","colLbl":"38"},{"location":"1551,862,66,22","text":"15.92","colLbl":"37"},{"location":"1562,889,56,20","text":"3.90","colLbl":"37"},{"location":"1562,913,55,23","text":"0.96","colLbl":"38"},{"location":"1577,940,37,17","text":"0.11","colLbl":"37"},{"location":"1576,966,41,17","text":"0.96","colLbl":"38"},{"location":"1559,1016,48,18","text":"11.91","colLbl":"38"},{"location":"1565,1096,50,16","text":"11.91","colLbl":"38"},{"location":"1563,1120,54,21","text":"0.40","colLbl":"37"},{"location":"1566,1149,49,15","text":"11.51","colLbl":"38"},{"location":"1577,1226,41,18","text":"0.00","colLbl":"38"},{"location":"1421,2269,67,18","text":"page pf","colLbl":"38"},{"location":"0,2320,302,18","text":"copyright@korean *insurance comoan","colLbl":"38"},{"location":"322,2321,50,17","text":"all agh","colLbl":"38"},{"location":"584,2250,480,17","text":"this is an electronically generated document nosignaturejs required","colLbl":"38"},{"location":"373,2323,86,13","text":"ts reserved","colLbl":"38"}],"fileName":"01_4369709.jpg"}'
    var resPyArr = JSON.parse(temp.replace(/'/g, '"'));
    return resPyArr;
}

